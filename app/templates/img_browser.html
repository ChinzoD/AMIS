{% extends "base.html" %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" type="text/css"
          href="{{ url_for('static', filename='scripts/lightbox/ekko-lightbox.css') }}"/>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css"
          integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
    <style>
        .loader {
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            -webkit-animation: spin 2s linear infinite; /* Safari */
            animation: spin 2s linear infinite;
            display: block;
            margin: 135px auto;
        }

        /* Safari */
        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }
            100% {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Frame */
        .frame {
            height: 200px;
            line-height: 200px;
            overflow: hidden;
        }

        .frame ul {
            list-style: none;
            margin: 0;
            padding: 0;
            height: 100%;
            font-size: 50px;
        }

        .frame ul li {
            float: left;
            width: 200px;
            height: 100%;
            margin: 0 1px 0 0;
            padding: 0;
            background: #000;
            color: #ddd;
            text-align: center;
            cursor: pointer;
        }

        .frame ul li.active {
            color: #fff;
            border-top: solid 3px #0aaaf1;
        {#background: #a03232;#}
        }

        /* Scrollbar */
        .scrollbar {
            margin: 0 0 1em 0;
            height: 2px;
            background: #ccc;
            line-height: 0;
        }

        .scrollbar .handle {
            height: 100%;
            background: #0aaaf1;
            cursor: pointer;
        }

        .scrollbar .handle .mousearea {
            position: absolute;
            top: -9px;
            left: 0;
            width: 100%;
            height: 20px;
        }

        /* Controls */
        .controls {
            margin: 25px 0;
            text-align: center;
        }

        /* One Item Per Frame example*/
        .oneperframe {
            height: 300px;
            line-height: 300px;
        }

        .oneperframe ul li {
            width: 1140px;
        }

        .oneperframe ul li.active {
            background: #333;
        }

        /* Crazy example */
        .crazy ul li:nth-child(2n) {
            width: 100px;
            margin: 0 4px 0 20px;
        }

        .crazy ul li:nth-child(3n) {
            width: 300px;
            margin: 0 10px 0 5px;
        }

        .crazy ul li:nth-child(4n) {
            width: 400px;
            margin: 0 30px 0 2px;
        }

    </style>
{% endblock %}


{% block app_content %}
    <div class="row">
        <div class="col-sm-3">
            <form>
                <div class="form-group row">
                    <label for="gene_dropdown" class="col-sm-4 col-form-label">Gene</label>
                    <div class="col-sm-6">
                        <select name="gene" class="form-control" id="gene_dropdown">
                            {% for gene in genes %}
                                <option value="{{ gene.gene_name.name }}"
                                        {% if gene_name == gene.gene_name.name %}
                                        selected
                                        {% endif %}
                                >{{ gene.gene_name.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="organ_dropdown" class="col-sm-4 col-form-label">Organ</label>
                    <div class="col-sm-6">
                        <select name="organ" class="form-control" id="organ_dropdown">
                            {% for organ in organs %}
                                <option value="{{ organ.name }}"
                                        {% if organ_name == organ.name %}
                                        selected
                                        {% endif %}
                                >{{ organ.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="organ_dropdown" class="col-sm-4 col-form-label">Experiment</label>
                    <div class="col-sm-6">
                        <select name="experiment" class="form-control" id="experiment_dropdown">
                            {% for experiment in experiments %}
                                <option value="{{ experiment.name }}">{{ experiment.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="organ_dropdown" class="col-sm-4 col-form-label">Sample Type</label>
                    <div class="col-sm-6">
                        <select name="sample_type" class="form-control" id="sample_dropdown">
                            <option value="LSM">Cleared</option>
                            <option value="other">Histological</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="col-sm-6" style="max-height: 450px; min-height: 450px; max-width: 900px; overflow: hidden;">
            <div class="row text-center">
                <div class="btn-group" id="specimen" data-toggle="buttons">
                </div>
                <div class="btn-group colors" id="wavelength" data-toggle="buttons">
                    <label class="btn btn-info active">
                        <input type="radio" name="options" value="tdTomato" autocomplete="off" checked> tdTomato
                    </label>
                    <label class="btn btn-info">
                        <input type="radio" name="options" value="DAPI" autocomplete="off"> Dapi
                    </label>
                </div>
            </div>
            <div class="row text-center">
                <br/>
                <div class="loader"></div>
                <div class="no_result controls center"><img
                        src="{{ url_for('static', filename='images/no_result.png') }}" height="300px">
                </div>
                <a href="" data-toggle="lightbox" data-max-width="800" height="600" class="selected_slice_a">
                    <img src="" class="selected_slice img-fluid" height="450px">
                </a>
            </div>
        </div>
        <div class="col-sm-3 slice_details">
        </div>
    </div>
    <div class="wrap">
        <div class="controls center">
            <button class="btn btn-info prev disabled" disabled=""><span
                    class="glyphicon glyphicon-chevron-left"></span>prev
            </button>
            <span class="" style="font-weight: bold;color: #0aaaf1;font-size: larger">
                (Slice <span class="current_id"></span> of <span class="total_result"></span>)
            </span>
            <button class="btn btn-info next">next <span class="glyphicon glyphicon-chevron-right"></span></button>
        </div>

        <div class="scrollbar">
            <div class="handle" style="transform: translateZ(0px) translateX(0px); width: 190px;">
                <div class="mousearea"></div>
            </div>
        </div>

        <div class="frame" id="forcecentered" style="overflow: hidden;">
            <ul class="clearfix"></ul>
        </div>
    </div>
    <div class="row">
        <div class="controls">
            <button type="button" class="btn btn-change-color btn-default">Change image color</button>
            <button type="button" class="btn btn-change-bg-color btn-default">Change background color</button>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='scripts/sly/sly.min.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/sly/examples/js/vendor/plugins.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/lightbox/ekko-lightbox.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/lightbox/ekko-lightbox.js.map') }}"></script>
    {#    <script src="{{ url_for('static', filename='scripts/sly/horizontal.js') }}"></script>#}
    <script type="text/javascript">
        $(document).ready(function () {
            var img_color = 1;
            var bg_color = 1;
            var total_result = 0;
            var mouse_number = "";
            var wavelength = "tdTomato";
            var $frame = $('#forcecentered');
            var $wrap = $frame.parent();

            var slyOptions = {
                horizontal: 1,
                itemNav: 'forceCentered',
                smart: 1,
                activateMiddle: 1,
                activateOn: 'click',
                mouseDragging: 1,
                touchDragging: 1,
                releaseSwing: 1,
                startAt: 0,
                scrollBar: $wrap.find('.scrollbar'),
                scrollBy: 1,
                speed: 300,
                elasticBounds: 1,
                easing: 'easeOutExpo',
                dragHandle: 1,
                dynamicHandle: 1,
                clickBar: 1,

                // Buttons
                prev: $wrap.find('.prev'),
                next: $wrap.find('.next')
            };

            updateSpecimen();


            $('#gene_dropdown').change(function () {
                slyOptions['startAt'] = 0;
                updateSpecimen();
            });

            $('#organ_dropdown').change(function () {
                slyOptions['startAt'] = 0;
                updateSpecimen();
            });

            $('#experiment_dropdown').change(function () {
                slyOptions['startAt'] = 0;
                updateContent();

            });

            $('#sample_dropdown').change(function () {
                slyOptions['startAt'] = 0;
                updateSpecimen();
            });

            $("#specimen").on('click', '.btn', function (event) {
                slyOptions['startAt'] = 0;
                mouse_number = $(this).find('input').val();
                console.log(mouse_number);
                updateContent();
            });

            $("#wavelength .btn").on('click', function (event) {
                wavelength = $(this).find('input').val();
                var current = parseInt($('.current_id').text()) - 1;
                slyOptions['startAt'] = current;
                updateContent();
            });

            function updateContent() {
                $('.loader').show();
                $('.selected_slice').hide();
                var url = "/slices?per_page=-1&order_by=slice_id";
                url += "&gene=" + $('#gene_dropdown').val() + "&organ=" + $('#organ_dropdown').val();
                url += "&experiment=" + $('#experiment_dropdown').val() + "&instrument=" + $('#sample_dropdown').val();
                url += "&wavelength=" + wavelength;
                if (mouse_number != "") {
                    url += "&mouse_number=" + mouse_number;
                }
                $.ajax({
                    type: 'GET',
                    url: url,
                    "dataType": "json",
                    "dataSrc": "items",
                    success: function (data) {
                        var content = "";
                        total_result = 0;
                        for (i in data.items) {
                            total_result++;
                            {#console.log(i);#}
                            content += "<li class='_" + i + "' id='" + data.items[i].id + "'><img src='" + data.items[i].img_url + "' width='200px' ></li>";
                        }
                        $('.total_result').html(total_result);
                        if (content.length == 0) {
                            $('.clearfix').html("<li>N/A</li>");
                        } else {
                            $('.clearfix').html(content);
                        }

                        $frame.sly(false);
                        $frame.sly(slyOptions);
                        $frame.sly('on', 'active', function (eventName, itemIndex) {
                            {#console.log(eventName);#}
                            {#console.log(itemIndex);#}
                            frameChange(itemIndex);
                        });
                        if (img_color == 1) {
                            img_color = 2;
                        } else {
                            img_color = 1;
                        }
                        changeFilter();
                        if (content.length > 0) {
                            frameChange(slyOptions['startAt']);
                        } else {
                            frameChange(-1);
                        }
                        $('.loader').hide();
                        $('.selected_slice').show();

                    }, error: function (jqXHR, status, err) {
                        console.log(status);
                    }
                });
            }

            function frameChange(index) {
                if (index == -1) {
                    $('.selected_slice_a').hide();
                    $('.no_result').show();
                    $('.slice_details').hide();
                    $('.current_id').html(0);
                } else {
                    if (total_result == 0) {
                        $('.current_id').html(0);
                    } else {
                        $('.current_id').html(index + 1);
                    }
                    $('.no_result').hide();
                    $('.selected_slice_a').show();
                    $('.slice_details').show();
                    var src = $('._' + index).find("img").attr('src');
                    $('.selected_slice').attr('src', src);
                    $('.selected_slice_a').attr('href', src);
                    var id = $('._' + index).attr('id');
                    updateSliceDetail(id);
                }

            }

            function updateSliceDetail(id) {
                $.ajax({
                    type: 'GET',
                    url: "/slices?id=" + id,
                    "dataType": "json",
                    "dataSrc": "items",
                    success: function (data) {
                        var content = "";
                        for (i in data.items) {
                            {#console.log(i);#}
                            content += "<p>Probe: " + data.items[i].gene + "</p>";
                            content += "<p>Magnification: <b>" + data.items[i].resolution + "</b></p>";
                            content += "<p>MD5: <b>" + data.items[i].checksum + "</b></p>";
                            content += "<a href=" + data.items[i].tif_url + ">Download TIF file</a>";
                        }
                        $('.slice_details').html(content);
                    }, error: function (jqXHR, status, err) {
                        console.log(status);
                        $('.alert-danger .text').text(err.toLowerCase() + '!');
                        $('.alert-danger').show();
                    }
                });
            }

            function updateSpecimen() {
                $.ajax({
                    type: 'GET',
                    url: "/mice?gene=" + $('#gene_dropdown').val() + "&organ=" + $('#organ_dropdown').val() + "&instrument=" + $('#sample_dropdown').val(),
                    "dataType": "json",
                    "dataSrc": "items",
                    success: function (data) {
                        var content = "";
                        console.log(data);
                        data.items.sort(compareValues('number', 'asc'));
                        data.items.sort(compareValues('sex', 'asc'));
                        data.items.sort(compareValues('spec', 'asc'));
                        console.log(data);
                        mouse_number = "";
                        for (i in data.items) {
                            {#console.log(i);#}
                            content += "<label class='btn btn2 btn-info";
                            if(mouse_number == ""){
                                mouse_number = data.items[i].number;
                                content += " active";
                            }
                            content += "'><input type='radio' name='options' ";
                            content += "value='" + data.items[i].number + "'> " + data.items[i].spec;

                            if (data.items[i].sex) {
                                content += " <i class='fas fa-mars'></i> ";
                            } else {
                                content += " <i class='fas fa-venus'></i> ";
                            }
                            content += data.items[i].age + " " + data.items[i].number + "</label>";
                        }
                        $('#specimen').html(content);
                        updateContent();
                    }, error: function (jqXHR, status, err) {
                        console.log(status);
                        $('.alert-danger .text').text(err.toLowerCase() + '!');
                        $('.alert-danger').show();
                    }
                });
            }

            function changeFilter() {
                if (img_color == 1) {
                    $(".selected_slice_a").css('-webkit-filter', 'brightness(10) invert(1)');
                    $(".frame li img").css('-webkit-filter', 'brightness(10) invert(1)');
                    $(".frame li").css('background', '#fff');
                    img_color = 2;
                } else {
                    $(".selected_slice_a").css('-webkit-filter', '');
                    $(".frame li  img").css('-webkit-filter', '');
                    $(".frame li").css('background', '#000');
                    img_color = 1;
                }
            }

            $(".btn-change-color").click(function () {
                changeFilter();
            });

            $(".btn-change-bg-color").click(function () {
                if (bg_color == 1) {
                    $("body").css('background-color', '#000');
                    $("body").css('color', '#fff');
                    bg_color = 2;
                } else {
                    $("body").css('background-color', '#fff');
                    $("body").css('color', '#000');
                    bg_color = 1;
                }
            });

            function compareValues(key, order = 'asc') {
                return function (a, b) {
                    if (!a.hasOwnProperty(key) || !b.hasOwnProperty(key)) {
                        // property doesn't exist on either object
                        return 0;
                    }

                    const varA = (typeof a[key] === 'string') ?
                        a[key].toUpperCase() : a[key];
                    const varB = (typeof b[key] === 'string') ?
                        b[key].toUpperCase() : b[key];

                    let comparison = 0;
                    if (varA > varB) {
                        comparison = 1;
                    } else if (varA < varB) {
                        comparison = -1;
                    }
                    return (
                        (order == 'desc') ? (comparison * -1) : comparison
                    );
                };
            }

        });
        $(document).on('click', '[data-toggle="lightbox"]', function (event) {
            event.preventDefault();
            $(this).ekkoLightbox();
        });
    </script>
{% endblock %}
